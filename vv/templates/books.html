<!-- backend/templates/books.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>图书列表 - 在线图书管理系统</title>
    <!-- 引入Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 30px;
        }
        .table th, .table td {
            vertical-align: middle;
        }
    </style>
</head>
<body>
    {{template "navbar.html" .}}
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>图书列表</h2>
            <div>
                <a href="/add_book" class="btn btn-primary">添加图书</a>
                <a href="/" class="btn btn-secondary">退出登录</a>
            </div>
        </div>

        <!-- 搜索表单 -->
        <div class="mb-3">
            <form id="searchForm" class="d-flex">
                <input type="text" id="searchQuery" class="form-control me-2" placeholder="搜索标题或作者">
                <button type="submit" class="btn btn-outline-success">搜索</button>
                <button type="button" id="clearSearch" class="btn btn-outline-secondary ms-2">清空</button>
            </form>
        </div>

        <!-- 图书表格 -->
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>标题</th>
                    <th>作者</th>
                    <th>描述</th>
                    <th>数量</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="bookList">
                <!-- 图书列表将通过前端JavaScript动态加载 -->
            </tbody>
        </table>
    </div>

    <!-- Modal for PDF Download Confirmation -->
    <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="pdfModalLabel">下载PDF</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
          </div>
          <div class="modal-body">
            确定要下载此图书的PDF文件吗？
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <a href="#" id="downloadLink" class="btn btn-primary">下载</a>
          </div>
        </div>
      </div>
    </div>

    <!-- 引入jQuery和Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 加载所有图书
        function loadBooks() {
            $.ajax({
                url: '/books',
                method: 'GET',
                success: function(data) {
                    $('#bookList').empty();
                    data.forEach(book => {
                        let pdfSection = '';
                        if (book.pdf_path) {
                            pdfSection = `
                                <a href="/${book.pdf_path}" target="_blank" class="btn btn-sm btn-info me-2">查看</a>
                                <form action="/books/${book.id}/upload_pdf" method="post" enctype="multipart/form-data" class="d-inline">
                                    <input type="file" name="pdf" accept="application/pdf" class="form-control mb-2" style="display: none;" onchange="this.form.submit()">
                                    <button type="button" class="btn btn-sm btn-warning" onclick="this.previousElementSibling.click()">上传/更换PDF</button>
                                </form>
                        `;
                        } else {
                            pdfSection = `
                                <form action="/books/${book.id}/upload_pdf" method="post" enctype="multipart/form-data" class="d-inline">
                                    <input type="file" name="pdf" accept="application/pdf" class="form-control mb-2" style="display: none;" onchange="this.form.submit()">
                                    <button type="button" class="btn btn-sm btn-warning" onclick="this.previousElementSibling.click()">上传PDF</button>
                                </form>
                            `;
                        }
                        $('#bookList').append(`
                            <tr>
                                <td>${book.id}</td>
                                <td>${book.title}</td>
                                <td>${book.author}</td>
                                <td>${book.description || '-'}</td>
                                <td>${book.quantity}</td>
                                <td>
                                    <a href="/books/${book.id}/edit" class="btn btn-sm btn-secondary me-2">编辑</a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.id})">删除</button>
                                    <div class="mt-2">
                                        ${pdfSection}
                                    </div>
                                </td>
                            </tr>
                        `);
                    });
                },
                error: function(err) {
                    alert('无法加载图书列表');
                }
            });
        }

        // 删除图书
        function deleteBook(id) {
            if(!confirm('确定要删除这本图书吗？')) return;
            $.ajax({
                url: '/books/' + id,
                method: 'DELETE',
                success: function(data) {
                    alert(data.message || '图书已删除');
                    loadBooks();
                },
                error: function(err) {
                    alert(err.responseJSON.error || '删除失败');
                }
            });
        }

        // 显示下载PDF的模态框
        function showDownloadModal(pdfPath) {
            $('#downloadLink').attr('href', '/' + pdfPath);
            var pdfModal = new bootstrap.Modal(document.getElementById('pdfModal'));
            pdfModal.show();
        }

        // 处理搜索表单提交
        $('#searchForm').on('submit', function(e) {
            e.preventDefault();
            const query = $('#searchQuery').val();
            if (query.trim() === "") {
                loadBooks();
                return;
            }
            $.ajax({
                url: '/search_books?q=' + encodeURIComponent(query),
                method: 'GET',
                success: function(data) {
                    $('#bookList').empty();
                    data.forEach(book => {
                        let pdfSection = '';
                        if (book.pdf_path) {
                            pdfSection = `
                                <a href="/${book.pdf_path}" target="_blank" class="btn btn-sm btn-info me-2">查看</a>
                                <form action="/books/${book.id}/upload_pdf" method="post" enctype="multipart/form-data" class="d-inline">
                                    <input type="file" name="pdf" accept="application/pdf" class="form-control mb-2" style="display: none;" onchange="this.form.submit()">
                                    <button type="button" class="btn btn-sm btn-warning" onclick="this.previousElementSibling.click()">上传/更换PDF</button>
                                </form>
                        `;
                        } else {
                            pdfSection = `
                                <form action="/books/${book.id}/upload_pdf" method="post" enctype="multipart/form-data" class="d-inline">
                                    <input type="file" name="pdf" accept="application/pdf" class="form-control mb-2" style="display: none;" onchange="this.form.submit()">
                                    <button type="button" class="btn btn-sm btn-warning" onclick="this.previousElementSibling.click()">上传PDF</button>
                                </form>
                            `;
                        }
                        $('#bookList').append(`
                            <tr>
                                <td>${book.id}</td>
                                <td>${book.title}</td>
                                <td>${book.author}</td>
                                <td>${book.description || '-'}</td>
                                <td>${book.quantity}</td>
                                <td>
                                    <a href="/books/${book.id}/edit" class="btn btn-sm btn-secondary me-2">编辑</a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.id})">删除</button>
                                    <div class="mt-2">
                                        ${pdfSection}
                                    </div>
                                </td>
                            </tr>
                        `);
                    });
                },
                error: function(err) {
                    alert('搜索失败');
                }
            });
        });

        // 清空搜索
        $('#clearSearch').on('click', function() {
            $('#searchQuery').val('');
            loadBooks();
        });

        // 初始加载所有图书
        loadBooks();
    </script>
</body>
</html>